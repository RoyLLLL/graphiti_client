在 LangGraph 对话流程中添加用户画像检索节点

在 OpenGPTs 中，Chatbot 和 RAGBot 架构都是基于 LangGraph 的 StateGraph。我们需要在对话图中添加一个初始化节点，在会话开始时调用 get_user_profile。例如，可以在 core/graph/definition.py 或 chatbot.py（具体取决于项目版本）中修改对话流程定义，在图的起始节点处插入“检索用户画像”节点。

伪代码示例：

from utils.graphiti_client import GraphitiClient

def get_profile_node(state):
    # 在状态中获取当前用户 ID（假设存储在 state.user_id）
    user_id = state.user_id  
    # 调用 Graphiti 客户端获取用户画像
    profile = graphiti_client.get_user_profile(user_id)
    # 将用户画像存入状态以便后续使用
    state.context["user_profile"] = {
        "name": profile.name,
        "language": profile.language,
        "location": profile.location,
        "timezone": profile.timezone
    }
    return state

# 在图定义中添加节点
graph.add_node(
    name="RetrieveUserProfile",
    func=get_profile_node,
    inputs=["*"],     # 确保在图执行开始前运行
    outputs=["*"]
)


这样，每当新会话开始时，LangGraph 都会执行 get_profile_node，调用 Graphiti 获取当前用户的画像，并将结果保存到共享状态（state.context 或其他状态字段）。这一设计灵感源自构建持久记忆的实践——首先从 Graphiti 中检索历史
blog.charlesmcchan.com
。
